import {Opik,OpikSpanType,logger}from'opik';var k=(e,t="",n={})=>{for(let o in e)if(Object.prototype.hasOwnProperty.call(e,o)){let r=t?`${t}.${o}`:o;typeof e[o]=="object"&&e[o]!==null&&!Array.isArray(e[o])?k(e[o],r,n):n[r]=e[o];}return n},w=e=>{let t={};for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&typeof e[n]=="number"&&(t[n]=e[n]);return t};var I=e=>({model:e.model,input:S(e),modelParameters:K(e)}),K=e=>["frequency_penalty","logit_bias","logprobs","max_tokens","n","presence_penalty","seed","stop","stream","temperature","top_p","user","response_format","top_logprobs"].reduce((n,o)=>e[o]!==void 0?{...n,[o]:e[o]}:n,{}),S=e=>$(e)?V(e):"prompt"in e?{prompt:e.prompt}:"input"in e?q(e.input):{},$=e=>!!(e&&typeof e=="object"&&!Array.isArray(e)&&"messages"in e),V=e=>["messages","function_call","functions","tools","tool_choice"].reduce((n,o)=>o in e?{...n,[o]:e[o]}:n,{}),q=e=>typeof e=="object"&&e!==null&&!Array.isArray(e)?e:{input:e},h=e=>{if(H(e))return {content:e.output_text};if(L(e)){let t=e.output,n=z(t);return n===null?void 0:Array.isArray(n)?{outputs:n}:n}if(J(e)){let t=Q(e);return typeof t=="string"?{content:t}:t}if(W(e))return X(e)},H=e=>e instanceof Object&&"output_text"in e&&typeof e.output_text=="string"&&e.output_text!=="",L=e=>!!(typeof e=="object"&&e!==null&&"output"in e&&Array.isArray(e.output)),z=e=>e.length>1?e:e.length===1&&typeof e[0]=="object"&&e[0]!==null?e[0]:e.length===1?{content:e[0]}:null,J=e=>!!(e instanceof Object&&"choices"in e&&Array.isArray(e.choices)&&e.choices.length>0),Q=e=>{let t=e.choices[0];return "message"in t&&typeof t.message=="object"&&t.message!==null?t.message:"text"in t&&t.text?String(t.text):""},W=e=>{if(!e||typeof e!="object"||!("data"in e)||!Array.isArray(e.data))return  false;let t=e.data;if(t.length===0)return  false;let n=t[0];return typeof n=="object"&&n!==null&&"embedding"in n&&Array.isArray(n.embedding)},P=5,X=e=>({embeddings:e.data.map(n=>{let o=n.embedding;return {embedding:o.length>P?[...o.slice(0,P),"..."]:o,index:n.index,dimensions:o.length}})}),R=e=>{if(Y(e))return {completion_tokens:e.usage.completion_tokens,prompt_tokens:e.usage.prompt_tokens,total_tokens:e.usage.total_tokens,...w(k(e.usage,"original_usage"))};if(Z(e))return {completion_tokens:e.usage.input_tokens,prompt_tokens:e.usage.output_tokens,total_tokens:e.usage.total_tokens,...w(k(e.usage,"original_usage"))};if(ee(e))return {completion_tokens:0,prompt_tokens:e.usage.prompt_tokens,total_tokens:e.usage.total_tokens,...w(k(e.usage,"original_usage"))}},Y=e=>{if(!e||typeof e!="object"||!("usage"in e)||!e.usage||typeof e.usage!="object")return  false;let t=e.usage;return typeof t.prompt_tokens=="number"&&typeof t.completion_tokens=="number"&&typeof t.total_tokens=="number"},Z=e=>{if(!e||typeof e!="object"||!("usage"in e)||!e.usage||typeof e.usage!="object")return  false;let t=e.usage;return typeof t.total_tokens=="number"&&typeof t.input_tokens=="number"&&typeof t.output_tokens=="number"},ee=e=>{if(!e||typeof e!="object"||!("usage"in e)||!e.usage||typeof e.usage!="object")return  false;let t=e.usage;return typeof t.prompt_tokens=="number"&&typeof t.total_tokens=="number"&&!("completion_tokens"in t)},D=e=>{var o,r;let t=e,n=(o=t==null?void 0:t.choices)==null?void 0:o[0];try{if(te(n))return {isToolCall:!0,data:n.delta.tool_calls[0]};if(ne(n))return {isToolCall:!1,data:((r=n.delta)==null?void 0:r.content)||""};if(oe(n))return {isToolCall:!1,data:n.text||""}}catch(a){logger.debug(`Error parsing chunk: ${a}`);}return {isToolCall:false,data:""}},te=e=>!!(e&&typeof e=="object"&&"delta"in e&&e.delta&&typeof e.delta=="object"&&"tool_calls"in e.delta&&Array.isArray(e.delta.tool_calls)&&e.delta.tool_calls.length>0),ne=e=>!!(e&&typeof e=="object"&&"delta"in e),oe=e=>!!(e&&typeof e=="object"&&"text"in e),j=e=>{let{name:t,arguments:n}=e.reduce((o,r)=>{var a,i;return {name:((a=r.function)==null?void 0:a.name)||o.name,arguments:o.arguments+(((i=r.function)==null?void 0:i.arguments)||"")}},{name:"",arguments:""});return {tool_calls:[{function:{name:t,arguments:n}}]}},T=e=>{if(typeof e!="object"||e===null)return {model:void 0,modelParameters:void 0,metadata:void 0};let t=ae(e)?e.model:void 0,n=re(e),o=se(e);return {model:t,modelParameters:Object.keys(n).length>0?n:void 0,metadata:Object.keys(o).length>0?o:void 0}},ae=e=>"model"in e&&typeof e.model=="string",re=e=>U(e,["max_output_tokens","parallel_tool_calls","store","temperature","tool_choice","top_p","truncation","user"]),se=e=>U(e,["reasoning","incomplete_details","instructions","previous_response_id","tools","metadata","status","error"]),U=(e,t)=>{let n={};for(let o of t)o in e&&e[o]!=null&&(n[o]=e[o]);return n};var _=e=>e!=null&&typeof e=="object"&&typeof e[Symbol.asyncIterator]=="function";var M=(e,t,n)=>{var o;t.span({...n,endTime:new Date,type:OpikSpanType.General,errorInfo:{message:e.message,exceptionType:e.name,traceback:(o=e.stack)!=null?o:""}}),t.end();},v=(e,t)=>(...n)=>ie(e,t,...n),ie=(e,t,...n)=>{var y;let{tags:o=[],...r}=(y=t==null?void 0:t.traceMetadata)!=null?y:{},{model:a,input:i,modelParameters:u}=I(n[0]),m={...r,...u,model:a},s={model:a,input:i,provider:"openai",name:t.generationName,tags:o,startTime:new Date,metadata:m},l,d=!!(t!=null&&t.parent);t!=null&&t.parent?l=t.parent:l=t.client.trace(s);try{let p=e(...n);return _(p)?E(p,l,d,s):p instanceof Promise?p.then(c=>{if(_(c))return E(c,l,d,s);let g=h(c),b=R(c),{model:x,metadata:N}=T(c),G={...s.metadata,...N,usage:b,model:x||s.model};return l.span({...s,output:g,endTime:new Date,usage:b,model:x||s.model,type:OpikSpanType.General,metadata:G}),d||l.update({output:g,endTime:new Date}),c}).catch(c=>{throw M(c,l,s),c}):p}catch(p){throw M(p,l,s),p}},ue=(e,t)=>{let n,o,r={...t};if(typeof e=="object"&&e&&"response"in e){let i=e.response;n=h(i);let{model:u,modelParameters:m,metadata:s}=T(i);r.model=u!=null?u:t.model,r.metadata={...t.metadata,...m,...s},typeof i=="object"&&i&&"usage"in i&&(o=i.usage);}typeof e=="object"&&e!=null&&"usage"in e&&(o=e.usage);let a=D(e);return {output:n,usage:o,chunkData:a,updatedObservationData:r}};function E(e,t,n,o){async function*r(){let a=[],i=[],m,s=null,l={...o};for await(let p of e){let{output:O,usage:c,chunkData:g,updatedObservationData:b}=ue(p,l);O&&(s=O),c&&(m=c),l=b,g.isToolCall?i=[...i,g.data]:a=[...a,g.data],yield p;}let d=s!=null?s:i.length>0?j(i):{message:a.join("")},y=R({usage:m});t.span({...l,output:d,endTime:new Date,type:OpikSpanType.General,usage:y}),n||t.update({output:d,endTime:new Date});}return r()}var f=class f{static getInstance(t){return f.instance||(f.instance=new Opik(t)),f.instance}};f.instance=null;var C=f;var F=(e,t)=>new Proxy(e,{get(n,o,r){var s,l,d;let a=n[o],i=(l=t==null?void 0:t.generationName)!=null?l:`${((s=e.constructor)==null?void 0:s.name)||"OpenAI"}.${o.toString()}`,u={...t,generationName:i,client:(d=t==null?void 0:t.client)!=null?d:C.getInstance()};return o==="flush"?u.client.flush.bind(u.client):typeof a=="function"?v(a.bind(n),u):a&&!Array.isArray(a)&&!(a instanceof Date)&&typeof a=="object"?F(a,u):Reflect.get(n,o,r)}});export{F as trackOpenAI};